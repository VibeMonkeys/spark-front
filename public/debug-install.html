<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#9333ea">
    <title>PWA ì„¤ì¹˜ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .result { margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #e8f5e8; border-color: #4caf50; }
        .error { background: #ffebee; border-color: #f44336; }
        .warning { background: #fff3e0; border-color: #ff9800; }
        button { padding: 10px 20px; margin: 5px; background: #9333ea; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #7c3aed; }
    </style>
</head>
<body>
    <h1>ğŸš€ PWA ì„¤ì¹˜ ê°•ì œ í…ŒìŠ¤íŠ¸</h1>
    <div id="results"></div>
    
    <button onclick="forceRegisterSW()">Service Worker ê°•ì œ ë“±ë¡</button>
    <button onclick="checkPWAInstallability()">PWA ì„¤ì¹˜ ê°€ëŠ¥ì„± ì²´í¬</button>
    <button onclick="showInstallPrompt()">ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ê°•ì œ í‘œì‹œ</button>
    <button onclick="manualInstallGuide()">ìˆ˜ë™ ì„¤ì¹˜ ê°€ì´ë“œ</button>
    
    <script>
        const results = document.getElementById('results');
        let deferredPrompt = null;
        
        function addResult(message, type = 'success') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            results.appendChild(div);
            console.log(message);
        }
        
        // PWA ì„¤ì¹˜ ì´ë²¤íŠ¸ ê°ì§€
        window.addEventListener('beforeinstallprompt', (e) => {
            addResult('ğŸ‰ PWA ì„¤ì¹˜ ê°€ëŠ¥! beforeinstallprompt ì´ë²¤íŠ¸ ë°œìƒ');
            e.preventDefault();
            deferredPrompt = e;
            
            // ì„¤ì¹˜ ë²„íŠ¼ ì¶”ê°€
            const installBtn = document.createElement('button');
            installBtn.textContent = 'ì§€ê¸ˆ ì„¤ì¹˜í•˜ê¸°!';
            installBtn.style.background = '#4caf50';
            installBtn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    addResult(`ì„¤ì¹˜ ê²°ê³¼: ${outcome}`);
                    deferredPrompt = null;
                }
            };
            results.appendChild(installBtn);
        });
        
        window.addEventListener('appinstalled', () => {
            addResult('ğŸ‰ PWA ì„¤ì¹˜ ì™„ë£Œ!');
            deferredPrompt = null;
        });
        
        // Service Worker ê°•ì œ ë“±ë¡
        async function forceRegisterSW() {
            try {
                // ê¸°ì¡´ ë“±ë¡ í•´ì œ
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (let registration of registrations) {
                    await registration.unregister();
                    addResult('ê¸°ì¡´ Service Worker í•´ì œë¨');
                }
                
                // ìƒˆë¡œ ë“±ë¡
                const registration = await navigator.serviceWorker.register('/sw.js', {
                    scope: '/'
                });
                addResult('âœ… Service Worker ì¬ë“±ë¡ ì™„ë£Œ');
                
                // ê°•ì œ í™œì„±í™”
                if (registration.waiting) {
                    registration.waiting.postMessage({ type: 'SKIP_WAITING' });
                }
                
                // ì ì‹œ í›„ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    addResult('í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ì¤‘...');
                    window.location.reload();
                }, 1000);
                
            } catch (error) {
                addResult('âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }
        
        // PWA ì„¤ì¹˜ ê°€ëŠ¥ì„± ì²´í¬
        function checkPWAInstallability() {
            addResult('ğŸ” PWA ì„¤ì¹˜ ì¡°ê±´ ì²´í¬ ì¤‘...');
            
            // ê¸°ë³¸ ì¡°ê±´ë“¤ ì²´í¬
            const checks = [
                { name: 'HTTPS ë˜ëŠ” localhost', result: location.protocol === 'https:' || location.hostname === 'localhost' },
                { name: 'Service Worker ì§€ì›', result: 'serviceWorker' in navigator },
                { name: 'Manifest ë§í¬ ì¡´ì¬', result: !!document.querySelector('link[rel="manifest"]') },
            ];
            
            checks.forEach(check => {
                addResult(`${check.result ? 'âœ…' : 'âŒ'} ${check.name}`, check.result ? 'success' : 'error');
            });
            
            // Chrome ì„¤ì¹˜ ì¡°ê±´ ê°•ì œ ì²´í¬
            setTimeout(() => {
                if (!deferredPrompt) {
                    addResult('âš ï¸ beforeinstallprompt ì´ë²¤íŠ¸ê°€ ì•„ì§ ë°œìƒí•˜ì§€ ì•ŠìŒ', 'warning');
                    addResult('ğŸ’¡ ëª‡ ì´ˆ ë” ê¸°ë‹¤ë¦¬ê±°ë‚˜ í˜ì´ì§€ì™€ ìƒí˜¸ì‘ìš© í•´ë³´ì„¸ìš”', 'warning');
                }
            }, 2000);
        }
        
        // ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ê°•ì œ í‘œì‹œ
        async function showInstallPrompt() {
            if (deferredPrompt) {
                addResult('ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ í‘œì‹œ ì¤‘...');
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                addResult(`ì‚¬ìš©ì ì„ íƒ: ${outcome}`);
            } else {
                addResult('âŒ ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ ì‚¬ìš© ë¶ˆê°€', 'error');
                
                // Chrome ë©”ë‰´ì—ì„œ ì„¤ì¹˜ ì‹œë„
                addResult('ğŸ’¡ Chrome ë©”ë‰´ì—ì„œ "ì•± ì„¤ì¹˜..." ì°¾ì•„ë³´ì„¸ìš”', 'warning');
                
                // ê°œë°œì ë„êµ¬ ì•ˆë‚´
                addResult('ğŸ”§ ë˜ëŠ” F12 â†’ Application â†’ Manifestì—ì„œ "Add to homescreen" ë²„íŠ¼ ì°¾ê¸°', 'warning');
            }
        }
        
        // ìˆ˜ë™ ì„¤ì¹˜ ê°€ì´ë“œ
        function manualInstallGuide() {
            const guide = `
                <h3>ğŸ› ï¸ ìˆ˜ë™ ì„¤ì¹˜ ë°©ë²•:</h3>
                <ol>
                    <li><strong>Chrome ë©”ë‰´(â‹®)</strong> í´ë¦­</li>
                    <li><strong>"ì•± ì„¤ì¹˜..."</strong> ë˜ëŠ” <strong>"Spark ì„¤ì¹˜..."</strong> ë©”ë‰´ ì°¾ê¸°</li>
                    <li>ì—†ìœ¼ë©´ <strong>ì£¼ì†Œì°½ ìš°í´ë¦­ â†’ "ì•± ì„¤ì¹˜..."</strong></li>
                    <li>ë˜ëŠ” <strong>F12 â†’ Application â†’ Manifest â†’ "Add to homescreen"</strong></li>
                </ol>
                <p>âš ï¸ Chromeì´ PWA ì„¤ì¹˜ ì¡°ê±´ì„ ê¹Œë‹¤ë¡­ê²Œ íŒë‹¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            `;
            
            const div = document.createElement('div');
            div.className = 'result warning';
            div.innerHTML = guide;
            results.appendChild(div);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì²´í¬
        window.addEventListener('load', () => {
            addResult('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            checkPWAInstallability();
            
            // 5ì´ˆ í›„ ìë™ ì¬ì²´í¬
            setTimeout(() => {
                if (!deferredPrompt) {
                    addResult('â° 5ì´ˆ ê²½ê³¼ - beforeinstallprompt ì´ë²¤íŠ¸ ì—¬ì „íˆ ì—†ìŒ', 'warning');
                }
            }, 5000);
        });
        
        // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ê°ì§€
        let interactionDetected = false;
        ['click', 'scroll', 'keydown'].forEach(event => {
            document.addEventListener(event, () => {
                if (!interactionDetected) {
                    interactionDetected = true;
                    addResult('ğŸ‘† ì‚¬ìš©ì ìƒí˜¸ì‘ìš© ê°ì§€ë¨ (PWA ì„¤ì¹˜ ì¡°ê±´ ì¶©ì¡±)');
                }
            }, { once: true });
        });
    </script>
</body>
</html>